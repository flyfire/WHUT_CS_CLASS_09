# 美团云架构

其实个人很想给大家分享一些云计算方面的技术，但是思来想去也不知道分享哪个方面才让大家感兴趣，自己还特意去知乎上搜了一搜关于云计算的话题，结果排名前三的是：云计算到底哪家强，云计算在中国的市场格局是怎样的，云计算的发展趋势是什么。。。而这些话题太大，个人水平有限肯定也讲不来。最后想到咱们美团云是美团基于python tornado架构完全自研的一套分布式计算资源管理系，个人在开发过程中觉得美团云架构算是一个非常不错的云计算服务架构，所以就想把美团云服务架构分享给大家。这里我一是水平有限，而是技术分享文档编写能力更差，所以如果其中有讲解有无，表达不清楚请大家尽情提出来，我会及时修正。

# 服务架构

下面给出美团云的一个整体抽象的服务架构，即美团云是如何处理API请求的。

![Image of cloud model](https://github.com/richardissuperman/sy0901/blob/master/万仔仁-Cloud-Computing101/images/cloud-model.png?raw=true)

云平台服务请求分为同步和异步请求，同步请求好理解，就是一些查询操作，API请求返回，整个请求过程就结束了。而异步请求到来之后会立即返回，之后云平台会通过task的方式来处理异步请求。

云平台服务架构里的几个组件说明：

*	Model: 资源管理模块（如云主机、磁盘存储和宿主机等资源）
*   	Task Manager: 任务管理模块，云平台对任何一种资源的操作都会以task的方式来处理，task定义为对特定资源的一系列操作。
*   	Worker threads: 每一个task会提交给工作线程来处理。

接下来我将通过云主机（Guest）创建的实际例子来介绍云平台服务运行流程。

这里首先简化下一台云主机创建的流程：创建磁盘 -> 配置系统 -> 启动云主机（当然云主机实际创建流程肯定要比这复杂得多），这里云主机（Guest）创建涉及到另外一种资源－－Disk的创建，所以云主机创建的Task里又包含了创建磁盘的子Task。至此就完成了云主机创建任务－－GuestCreateTask的定义：

![Image of guestcreatetask](https://github.com/richardissuperman/sy0901/blob/master/万仔仁-Cloud-Computing101/images/guestcreatetask.png?raw=true)

从Task定义的伪代码可以看出，一个Task可以包含多个子Task，Task每个操作也都包含1个或多个HTTP请求。因为Task每个操作都涉及到HTTP请求，为了保证每次HTTP请求返回之后，Task能继续上一次处理的步骤继续向下执行，云平台会记录每个Task执行的运行时参数以及当前执行到的步骤。

![Image of guestcreatetask-execute](https://github.com/richardissuperman/sy0901/blob/master/万仔仁-Cloud-Computing101/images/guestcreatetask-execute.png?raw=true)

# 服务水平扩展

云平台是一个分布式的平台，就肯定涉及到服务的水平扩展问题。这里只介绍下云平台控制服务（Region）和宿主机服务（Host-Srv）的水平扩展：

*	Region水平扩展：云平台控制服务的水平扩展比较难，因为这里涉及到了QPS与性能权衡的问题。在云平台初期，一台Region服务节点用来处理读写请求就OK；而当业务量上升到一个量级，就会发现服务请求处理比较吃力了，这时候可以简单的做下服务读写分离，这个读写分离是在nginx上做，即定义一个写节点和多个读节点，让nginx将所有的写节点转发到唯一的写节点上，然后将读请求转发到读节点上，到目前为止还只有一个写节点，所有还不需要分布式锁，性能还不受影响；而当业务量再上升到一个量级，这时候一个写节点肯定是处理不过来的，那么这时候就需要添加多个写节点了，为了保持数据一致性，就需要添加分布式锁（zk，etcd），而如果分布式锁粒度设计有问题的话，就会对服务性能产生很大的影响。
*	Host-Srv水平扩展：host服务的水平扩展就非常容易了，这里没有数据一致性问题，所以可以达到即插即用的效果。
