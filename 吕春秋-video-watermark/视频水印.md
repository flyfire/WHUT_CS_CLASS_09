# 视频水印

视频处理是个很有（tai）意（shao）思（nao）的技术，这篇文章分享了我所在的公司所从事的工作，那就是视频水印，个人水平有限，欢迎大家拍砖。

## 公司介绍

首先介绍一下我们公司，主要做数字平台的安全业务，比较大的几个业务包括媒体娱乐安全和支付安全，媒体娱乐安全包括了电视，机顶盒，制片安全等等，从媒体内容分发一直到客户终端。我所在的水印组（watermarking）的工作就是给制片公司的视频内容加水印，帮助他们打击盗版。

## 基本概念

关于视频，两个重要概念就是容器格式（container format）和编解码格式（codec format）。简而言之，容器格式描述了元数据（时间，标题等等），字幕，同步信息，视频音频数据。平时见到的视频后缀正是其容器格式，比如mov/mp4，mkv。而编解码格式描述了压缩数据如何解码成原始数据和其逆过程（编码），目前我接触到的有prores，H.264/AVC，H.265/HEVC。容器格式和编解码格式是一个多对多的关系，也就是说，一种容器格式可以支持多种编解码，而一种编解码格式也可以存在于多种容器格式中，各个标准里面都有明确的介绍。

这两种类型的格式各有很多，每一种格式都是一个复杂的标准，下面以我接触过的mov/mp4和H.264/AVC为例简单介绍一下。

### mov/mp4容器格式

这种格式的数据由一个个box/atom相互嵌套组成，每个box都保存了自己的信息，下面的图片举例给出了box的层级结构（来自[1]），比如第一层

[MP4 box层级图片]

* fytp 描述了视频文件的类型兼容性等基本信息
* moov 描述了如何解析mdat（媒体数据），也就是元数据的集合，可以看到它包含的box层级很多，因为它详细描述了媒体数据的各种信息，比如编解码格式，每一帧视频数据的时间和位置等等
* mdat 视频音频数据

### H.264/AVC 视频编解码格式
编解码的主要目的在于尽可能压缩数据和避免失真，一个1080p视频的原始画面帧含有1920*1080个像素点，假如每个点由三个8-bit的YUV（RGB的等价形式）表示，一帧数据需要接近60Mb的数据量，假设一秒钟有24帧，那随便一个视频就需要很大的储存空间了。为了解决这个问题H.264采用了以下几种主要技术

* 帧间和帧内预测：利用视频数据的相关性，这部分特别有意思，下面会着重介绍
* 数据量化：用有限的位数最大限度表示原始数据
* 余弦变换:空间域到频率域的变化，纯数学很枯燥
* 。。。



[1] MP4文件格式的解析，以及MP4文件的分割算法, http://www.cnblogs.com/haibindev/archive/2011/10/17/2214518.html

未完待续