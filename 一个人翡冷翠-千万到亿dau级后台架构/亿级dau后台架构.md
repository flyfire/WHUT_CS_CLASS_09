# DAU亿级app后台架构

在腾讯工作的好处就是你参与的随便一个project大都是千万dau甚至亿级的，一个千万级dau的app的技术迷人之处在于它已经是一个平台，它有着特别丰富的业务形态，你会发现许多技术瓶颈并解决它。

我想分享的就是我工作一年多来主力参与腾讯一个千万级app的架构心得。

# 从架构图讲起
<p align="center">
	<img src=https://github.com/richardissuperman/WHUT_CS_CLASS_09/blob/master/%E4%B8%80%E4%B8%AA%E4%BA%BA%E7%BF%A1%E5%86%B7%E7%BF%A0-%E5%8D%83%E4%B8%87%E5%88%B0%E4%BA%BFdau%E7%BA%A7%E5%90%8E%E5%8F%B0%E6%9E%B6%E6%9E%84/image/%E6%9E%B6%E6%9E%84%E5%9B%BE.jpg width=400>
</p>

架构分为三层：接入层，业务层、数据层。

*	接入层

	接入层主要负责服务的转发、通讯信道的安全、认证通过后的票据鉴权、请求的上行和下行通道。

	接入层是无状态接入，平行扩展。接入首先要保证的是通信信道的安全，什么是安全信道，简单点说就是经过一定加密手段的数据通信，即使对方抓包知道你传输的数据，截获此数据也没有任何影响的信道。http是不安全信道，https就是安全信道，https主要是用了openssl的方法对通信数据进行加密，简单概括就是对请求参数用hmacsha1做计算得到一个签名，在传输的对端同样做一次hamcsha1的运算，比较签名是否一致。保证信道的安全有很多方法，对称和非对称加密算法，加盐防止彩虹表攻击，加时间戳和随机数防止ddos攻击等等。我们一般采取多种策略同时保护通信安全，就不展开讲了。

	接入层最主要的作用就是请求的转发，每个请求都有一个命令号，通过命令号找到需要路由的逻辑服务，转发给具体业务服务。

	接入层也提供了票据鉴权的能力。票据是什么？票据就是签名，形象一点，票据其实可以理解为现实世界中的“电影票”、“飞机票”等等，是一种凭证。以电影票为例，我们去看电影需要首先购买电影票，然后拿着电影票在规定的时刻去电影院，检票入场后观看电影。我们能感受到票据最直接的场景就是，你大部分时间打开微信或者qq的时候，你是不需要输入用户名、密码的，这就是票据的作用，减少了登陆鉴权给用户带来不方便。只需要第一次输入用户名密码之后换到票据，客户端缓存这个票据，以后所有的请求带上这个票据服务器做校验，就免去了雍长的登陆鉴权流程。当然票据也是经过复杂的对称加密算法实现，票据有过期时间，服务器也可以主动使票据失败，当客户端拿到的票据过期或者经过篡改，服务器鉴别失败，那就需要重新走一边登陆流程去刷新票据。登陆鉴权换票是在下面要讲的业务层基础服务登陆认证里，接入层保持票据认证的能力。

<p align="center">
	<img src=https://github.com/richardissuperman/WHUT_CS_CLASS_09/blob/master/%E4%B8%80%E4%B8%AA%E4%BA%BA%E7%BF%A1%E5%86%B7%E7%BF%A0-%E5%8D%83%E4%B8%87%E5%88%B0%E4%BA%BFdau%E7%BA%A7%E5%90%8E%E5%8F%B0%E6%9E%B6%E6%9E%84/image/%E7%A5%A8%E6%8D%AE.jpg width=400>
</p>

	通道数据的上行下行能力能极大地提升业务能力，是聊天、消息、广播、群组、房间等这些业务形态的基础。简单举一个例子，你用微信给你朋友发了一个消息，消息为什么能到你朋友的这个手机，有没有想过这个问题。你朋友能收到这个消息，肯定是微信的后台服务器记录了你朋友手机的ip地址和端口，并且你朋友手机的微信客户端和服务器之间维持了一条长链接通道，你发的消息是上行，服务器推到你朋友的手机是下行。接入层维持每一个用户一条长链接通道是

*	业务层

*	数据层



