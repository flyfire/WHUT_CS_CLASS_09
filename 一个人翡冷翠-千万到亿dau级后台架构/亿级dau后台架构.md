# DAU亿级app后台架构

在腾讯工作的好处就是你参与的随便一个project大都是千万dau甚至亿级的，一个千万级dau的app的技术迷人之处在于它已经是一个平台，它有着特别丰富的业务形态，你会发现许多技术瓶颈并解决它。

我想分享的就是我工作一年多来主力参与腾讯一个千万级app的架构心得。

# 从架构图讲起
<p align="center">
	<img src=https://github.com/richardissuperman/WHUT_CS_CLASS_09/blob/master/%E4%B8%80%E4%B8%AA%E4%BA%BA%E7%BF%A1%E5%86%B7%E7%BF%A0-%E5%8D%83%E4%B8%87%E5%88%B0%E4%BA%BFdau%E7%BA%A7%E5%90%8E%E5%8F%B0%E6%9E%B6%E6%9E%84/image/%E6%9E%B6%E6%9E%84%E5%9B%BE.jpg width=500>
</p>

架构分为三层：接入层，业务层、数据层。

*	接入层

	接入层主要负责服务的转发、通讯信道的安全、认证通过后的票据鉴权、请求的上行和下行通道。

	接入层是无状态接入，平行扩展。接入首先要保证的是通信信道的安全，什么是安全信道，简单点说就是经过一定加密手段的数据通信，即使对方抓包知道你传输的数据，截获此数据也没有任何影响的信道。http是不安全信道，https就是安全信道，https主要是用了openssl的方法对通信数据进行加密，简单概括就是对请求参数用hmacsha1做计算得到一个签名，在传输的对端同样做一次hamcsha1的运算，比较签名是否一致。保证信道的安全有很多方法，对称和非对称加密算法，加盐防止彩虹表攻击，加时间戳和随机数防止ddos攻击等等。我们一般采取多种策略同时保护通信安全，就不展开讲了。

	接入层最主要的作用就是请求的转发，每个请求都有一个命令号，通过命令号找到需要路由的逻辑服务，转发给具体业务服务。

	接入层也提供了票据鉴权的能力。票据是什么？票据就是签名，形象一点，票据其实可以理解为现实世界中的“电影票”、“飞机票”等等，是一种凭证。以电影票为例，我们去看电影需要首先购买电影票，然后拿着电影票在规定的时刻去电影院，检票入场后观看电影。我们能感受到票据最直接的场景就是，你大部分时间打开微信或者qq的时候，你是不需要输入用户名、密码的，这就是票据的作用，减少了登陆鉴权给用户带来不方便。只需要第一次输入用户名密码之后换到票据，客户端缓存这个票据，以后所有的请求带上这个票据服务器做校验，就免去了雍长的登陆鉴权流程。当然票据也是经过复杂的对称加密算法实现，票据有过期时间，服务器也可以主动使票据失败，当客户端拿到的票据过期或者经过篡改，服务器鉴别失败，那就需要重新走一边登陆流程去刷新票据。登陆鉴权换票是在下面要讲的业务层基础服务登陆认证里，接入层保持票据认证的能力。

	<p align="center">
	<img src=https://github.com/richardissuperman/WHUT_CS_CLASS_09/blob/master/%E4%B8%80%E4%B8%AA%E4%BA%BA%E7%BF%A1%E5%86%B7%E7%BF%A0-%E5%8D%83%E4%B8%87%E5%88%B0%E4%BA%BFdau%E7%BA%A7%E5%90%8E%E5%8F%B0%E6%9E%B6%E6%9E%84/image/%E7%A5%A8%E6%8D%AE.jpg width=400>
	</p>


	通道数据的上行下行能力能极大地提升业务能力，是聊天、消息、广播、群组、房间等这些业务形态的基础。简单举一个例子，你用微信给你朋友发了一个消息，消息为什么能到你朋友的这个手机，有没有想过这个问题。你朋友能收到这个消息，肯定是微信的后台服务器记录了你朋友手机的ip地址和端口，并且你朋友手机的微信客户端和服务器之间维持了一条长链接通道，你发的消息是上行，服务器推到你朋友的手机是下行。接入层维持每一个用户一条长链接通道，客户端维持心跳去保活通道，这是通道上行、下行的关键，有了上行和下行的能力，消息才能够闭环，业务就会有更多形态的可能性。

	推送（push）是一种离线消息通知的能力，原理和上面讲的一样，只不过推送变成了操作系统级的进程去维持这个长链接，因为app会被杀死，app级的长链接通道不可靠，时常会被杀掉。苹果是apns，安卓就种类繁多，基本每一个大的手机厂商都会有自己的系统级的长链接通道。

*	业务层

	业务层就是业务服务器提供业务能力。我们能够想到的一个最简单的联网app需要哪些必备的业务功能：登陆、账户资料、消息、在线、开关。再复杂点的业务形态就会有社区，好友关系链、1v1聊天、小群组聊天、大型聊天室聊天、类朋友圈、类微博等这种基本的业务。每一种业务都可以用一种专门的业务服务去处理，这就是我上面架构图里画的那么多繁多复杂的业务。只要有登录就有在线，就会有登陆认证服务和在线状态服务，登陆认证服务就是上面接入层说的鉴权产生票据的地方。一台服务器肯定扛不住亿级dau的量，那么多台业务服务器就需要重定向和负载均衡服务去调度。app做大了之后肯定会有非法的用户请求和攻击，这就需要访问控制策略服务去分析策略拒绝访问请求。业务服务随着业务形态变化很大，就不一一说具体实现了，每一个业务服务的技术细节和难点都可以用一个很大的篇幅来讲，就不细说了。总之后台服务要根据业务形态考虑充分考虑服务器的瓶颈，比如微博这种业务形态，一个大v几千万粉丝，他发一个微博要几千万粉丝都可以看到，这就是严重的读扩散。再比如朋友圈，这种业务形态，每个人的好友有上限，一个人发的朋友圈最多只会扩散几千人，就可以用异步队列+写扩散来做。这种业务机器都不是瓶颈，再想想聊天室这种业务形态，一个百万人在线的聊天室，每一个人发一条消息所有的100万人都要看到，消息的扩散量是100万*100万，这时候服务器的网卡，cpu会成为瓶颈，解决这些问题都极具挑战。再比如所有的消息经过服务器，服务器怎么确保消息不会串，你发给我的消息不发给其他人，这就需要给消息一个惟一的id去辨识，就需要唯一id序列号生成服务，有想过怎么无锁并发地分配10亿个完全不同的唯一id吗？

*	数据层
	
	所有业务数据都要落地和缓存，需要数据介质做存储这些数据。我们现在用的比较多的是mysql和redis。对这些存储介质的优化、特性花定制、业务适配改进每一项又可以长篇累牍地讲，也不展开了。


讲到这里，我通过你用qq或者微信给群发一个语音这个场景用后台技术的方式把上面我讲的架构串起来。

1.你输入用户名密码登陆微信，首先客户端会发送一个tcp短链接到接入层服务的域名（假设有100台接入层服务器分布全国几个大城市），随机请求到一台接入层服务器，接入层服务器会带着这个用户的ip地址去重定向服务根据策略（就近地址、就近运营商、机器当前负载等因素）去分配一个可靠的接入层机器ip给客户端，客户端拿到这个可靠的接入层ip后建立和这台接入层机器的长链接，并每隔一段时间发送心跳来维持这个长链接，上下行通道建立了起来。

2.这个时候客户端才会发送真正的登陆认证请求到接入层，接入层通过请求命令字把请求转发到登陆认证服务器，登陆认证服务器认证通过后，下发票据用户id等给客户端。并通知在线状态服务，在线状态服务记录你在线，并且记录你接入层的ip等信息。

3.你给一个群发了一个语音，实际带来的请求是这样的，客户端发送语音去上传到cdn，cdn下发客户端具体的语音url地址，客户端带着票据、语音url、用户id、群组id等参数发起群组聊天请求到刚才那台接入层服务器，接入层服务器验证票据通过后把请求转发到群组聊天服务器，群组聊天服务把消息分配一个自增的序列号，群组聊天服务器维持了全量内存的群组用户数据，这个数据是通过用户登陆在线的方式从接入层订阅过来的。查到这个群的所有用户成员的在线状态后，如果在线通过在线状态服务找到这个成员的接入层ip，把找到的接入层ip+消息序列号+消息内容（语音url）+发送者的用户id+接收着的用户id到消息服务器，消息服务器找到接受者的未读消息序列号，把最新消息序列号和未读消息序列号之间的消息都发送给找到的接入层ip，用客户端和接入层服务器保持的长链接通道直接下发给群组里的每一个客户端。如果群组里有的成员是离线，那消息服务就直接把这些信息发送给苹果apns，推送给客户端。

这就是一个完整的消息业务流程，中间省去了很多细节，希望能把前面所讲的串起来给方便大家理解。

当然一些主流的技术我们也都在逻辑业务上用，比如既然有了用户的海量数据，会有spark、storm、hive等服务给我们去分析用户数据，给产品运营提供一个正确的方向和灵感。也会用tensorflow做一些应用级的人工智能分析等等。
这次就分享这么多，抛砖引玉，欢迎和推荐更多的同学来腾讯工作，感受亿级产品的魅力。


